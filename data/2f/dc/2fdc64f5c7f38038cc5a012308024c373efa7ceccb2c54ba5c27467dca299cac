[{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/719825831","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-719825831","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":719825831,"node_id":"MDEyOklzc3VlQ29tbWVudDcxOTgyNTgzMQ==","user":{"login":"jhpoelen","id":1084872,"node_id":"MDQ6VXNlcjEwODQ4NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1084872?v=4","gravatar_id":"","url":"https://api.github.com/users/jhpoelen","html_url":"https://github.com/jhpoelen","followers_url":"https://api.github.com/users/jhpoelen/followers","following_url":"https://api.github.com/users/jhpoelen/following{/other_user}","gists_url":"https://api.github.com/users/jhpoelen/gists{/gist_id}","starred_url":"https://api.github.com/users/jhpoelen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhpoelen/subscriptions","organizations_url":"https://api.github.com/users/jhpoelen/orgs","repos_url":"https://api.github.com/users/jhpoelen/repos","events_url":"https://api.github.com/users/jhpoelen/events{/privacy}","received_events_url":"https://api.github.com/users/jhpoelen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-10-30T22:21:31Z","updated_at":"2020-10-30T22:21:31Z","body":"hint: \r\n\r\nconfigure nginx to execute a preston instance and stream the results as part of the response. ","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/719825831/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720779235","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-720779235","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":720779235,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDc3OTIzNQ==","user":{"login":"mielliott","id":9602463,"node_id":"MDQ6VXNlcjk2MDI0NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9602463?v=4","gravatar_id":"","url":"https://api.github.com/users/mielliott","html_url":"https://github.com/mielliott","followers_url":"https://api.github.com/users/mielliott/followers","following_url":"https://api.github.com/users/mielliott/following{/other_user}","gists_url":"https://api.github.com/users/mielliott/gists{/gist_id}","starred_url":"https://api.github.com/users/mielliott/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mielliott/subscriptions","organizations_url":"https://api.github.com/users/mielliott/orgs","repos_url":"https://api.github.com/users/mielliott/repos","events_url":"https://api.github.com/users/mielliott/events{/privacy}","received_events_url":"https://api.github.com/users/mielliott/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-02T23:15:33Z","updated_at":"2020-11-02T23:16:03Z","body":"@jhpoelen here's a first go of it:\r\n\r\nI used the nifty socat tool to create a web interface for preston:\r\n```\r\nsocat TCP4-LISTEN:8080,reuseaddr,fork SYSTEM:\"./preston-web-service.sh\" \r\n```\r\nsocat streams incoming HTTP requests to https://github.com/bio-guoda/preston-scripts/blob/main/preston-web-service.sh, who looks at the request URI and decides what preston needs to do for us, then runs the appropriate Preston command and streams his output back to whoever issued the HTTP request.\r\n\r\nI then told nginx to redirect requests to the socat server:\r\n```\r\nserver {\r\n    listen 80 default_server;\r\n    listen [::]:80 default_server;\r\n\r\n    merge_slashes off; # this stops \"hash://\" from being interpreted as \"hash:/\"\r\n    location ~ \"/(get|cat)/(.*)\" {\r\n        proxy_pass http://127.0.0.1:8080/$1/$2;\r\n    }\r\n}\r\n```\r\n\r\nand then used cURL to ask Preston for stuff:\r\n```\r\n$ curl 'localhost/cat/zip:hash://sha256/314575f66a10953a3cc5c6c8db4df74c593a878090f2387ee02fbcdd85ebcd2f!/eml.xml'\r\n<eml:eml xmlns:eml=\"eml://ecoinformatics.org/eml-2.1.1\"\r\n         xmlns:dc=\"http://purl.org/dc/terms/\"\r\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n         xsi:schemaLocation=\"eml://ecoinformatics.org/eml-2.1.1 http://rs.gbif.org/schema/eml-gbif-profile/1.1/eml.xsd\"\r\n         packageId=\"5f3463d2-51b6-4a8a-b252-9bab4388934e/v34.39\" system=\"http://gbif.org\" scope=\"system\"\r\n         xml:lang=\"eng\">\r\n...\r\n```\r\nand Preston delivers.\r\n\r\nNote that I only configured nginx to forward get/cat commands. Any command can be curled to the socat port directly (if accessible), e.g.\r\n```\r\n$ curl 'localhost:8080/version\r\n```\r\n\r\nI've only tested this on my own local machine, so it isn't yet deployed on preston.guoda.bio.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720779235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720782798","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-720782798","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":720782798,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDc4Mjc5OA==","user":{"login":"mielliott","id":9602463,"node_id":"MDQ6VXNlcjk2MDI0NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9602463?v=4","gravatar_id":"","url":"https://api.github.com/users/mielliott","html_url":"https://github.com/mielliott","followers_url":"https://api.github.com/users/mielliott/followers","following_url":"https://api.github.com/users/mielliott/following{/other_user}","gists_url":"https://api.github.com/users/mielliott/gists{/gist_id}","starred_url":"https://api.github.com/users/mielliott/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mielliott/subscriptions","organizations_url":"https://api.github.com/users/mielliott/orgs","repos_url":"https://api.github.com/users/mielliott/repos","events_url":"https://api.github.com/users/mielliott/events{/privacy}","received_events_url":"https://api.github.com/users/mielliott/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-02T23:25:22Z","updated_at":"2020-11-02T23:25:22Z","body":"Also, I'm not sure yet how to go about returning error codes. Since we're streaming things, the HTTP header gets streamed out before preston even starts doing its job, so I'm not sure the best way to see if preston complains or not (e.g. if a `hash://blah` can't be resolved, or if a `cut:zip:hash://blah!/yadda` is malformed) before setting the status code. As far as I can tell, I can't get an exit status from Preston until it finishes executing. Right now, I just always return 200 OK, but maybe we sometimes want to return a 404/etc.","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720782798/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720861075","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-720861075","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":720861075,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDg2MTA3NQ==","user":{"login":"jhpoelen","id":1084872,"node_id":"MDQ6VXNlcjEwODQ4NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1084872?v=4","gravatar_id":"","url":"https://api.github.com/users/jhpoelen","html_url":"https://github.com/jhpoelen","followers_url":"https://api.github.com/users/jhpoelen/followers","following_url":"https://api.github.com/users/jhpoelen/following{/other_user}","gists_url":"https://api.github.com/users/jhpoelen/gists{/gist_id}","starred_url":"https://api.github.com/users/jhpoelen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhpoelen/subscriptions","organizations_url":"https://api.github.com/users/jhpoelen/orgs","repos_url":"https://api.github.com/users/jhpoelen/repos","events_url":"https://api.github.com/users/jhpoelen/events{/privacy}","received_events_url":"https://api.github.com/users/jhpoelen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-03T01:54:14Z","updated_at":"2020-11-03T01:54:14Z","body":"Cool to see that you used socat + nginx + preston . How modular! \n\nPerhaps the acis informatics folks have some ideas on how to manage the return codes. \n\nAm looking forward to getting this up and running publicly. If you feel comfortable, you can apply the changes on the server. If not, I'd be happy to help you through the process.\n\nSo now we'll just have to build a lightweight web api on top of Kafka right?\n\nHoping to give your socat/nginx/preston trifecta a try tomorrow!\n\n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/720861075/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/721382244","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-721382244","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":721382244,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMTM4MjI0NA==","user":{"login":"mielliott","id":9602463,"node_id":"MDQ6VXNlcjk2MDI0NjM=","avatar_url":"https://avatars.githubusercontent.com/u/9602463?v=4","gravatar_id":"","url":"https://api.github.com/users/mielliott","html_url":"https://github.com/mielliott","followers_url":"https://api.github.com/users/mielliott/followers","following_url":"https://api.github.com/users/mielliott/following{/other_user}","gists_url":"https://api.github.com/users/mielliott/gists{/gist_id}","starred_url":"https://api.github.com/users/mielliott/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mielliott/subscriptions","organizations_url":"https://api.github.com/users/mielliott/orgs","repos_url":"https://api.github.com/users/mielliott/repos","events_url":"https://api.github.com/users/mielliott/events{/privacy}","received_events_url":"https://api.github.com/users/mielliott/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-03T21:25:11Z","updated_at":"2020-11-03T21:25:11Z","body":"> Perhaps the acis informatics folks have some ideas on how to manage the return codes.\r\n\r\nMaybe, I can check with them.\r\n\r\n> Am looking forward to getting this up and running publicly.\r\n\r\nCheck it out!\r\n\r\nhttps://preston.guoda.bio/version\r\n\r\nhttps://preston.guoda.bio/cat/zip:hash://sha256/314575f66a10953a3cc5c6c8db4df74c593a878090f2387ee02fbcdd85ebcd2f!/eml.xml\r\n\r\nhttps://preston.guoda.bio/cat/cut:zip:hash://sha256/314575f66a10953a3cc5c6c8db4df74c593a878090f2387ee02fbcdd85ebcd2f!/eml.xml!/b822-844\r\n\r\n> So now we'll just have to build a lightweight web api on top of Kafka right?\r\n\r\nSounds about right!\r\n\r\n> Hoping to give your socat/nginx/preston trifecta a try tomorrow!\r\n\r\nExciting!","author_association":"COLLABORATOR","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/721382244/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null},{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/721400892","html_url":"https://github.com/bio-guoda/preston/issues/94#issuecomment-721400892","issue_url":"https://api.github.com/repos/bio-guoda/preston/issues/94","id":721400892,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMTQwMDg5Mg==","user":{"login":"jhpoelen","id":1084872,"node_id":"MDQ6VXNlcjEwODQ4NzI=","avatar_url":"https://avatars.githubusercontent.com/u/1084872?v=4","gravatar_id":"","url":"https://api.github.com/users/jhpoelen","html_url":"https://github.com/jhpoelen","followers_url":"https://api.github.com/users/jhpoelen/followers","following_url":"https://api.github.com/users/jhpoelen/following{/other_user}","gists_url":"https://api.github.com/users/jhpoelen/gists{/gist_id}","starred_url":"https://api.github.com/users/jhpoelen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jhpoelen/subscriptions","organizations_url":"https://api.github.com/users/jhpoelen/orgs","repos_url":"https://api.github.com/users/jhpoelen/repos","events_url":"https://api.github.com/users/jhpoelen/events{/privacy}","received_events_url":"https://api.github.com/users/jhpoelen/received_events","type":"User","user_view_type":"public","site_admin":false},"created_at":"2020-11-03T22:11:31Z","updated_at":"2020-11-03T22:11:31Z","body":"This is beyond cool!\n\n```\n$ curl --silent 'https://preston.guoda.bio/cat/cut:zip:hash://sha256/314575f66a10953a3cc5c6c8db4df74c593a878090f2387ee02fbcdd85ebcd2f!/eml.xml' | head \n<eml:eml xmlns:eml=\"eml://ecoinformatics.org/eml-2.1.1\"\n         xmlns:dc=\"http://purl.org/dc/terms/\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"eml://ecoinformatics.org/eml-2.1.1 http://rs.gbif.org/schema/eml-gbif-profile/1.1/eml.xsd\"\n         packageId=\"5f3463d2-51b6-4a8a-b252-9bab4388934e/v34.39\" system=\"http://gbif.org\" scope=\"system\"\n         xml:lang=\"eng\">\n\n<dataset>\n  <alternateIdentifier>5f3463d2-51b6-4a8a-b252-9bab4388934e</alternateIdentifier>\n  <alternateIdentifier>http://ipt.vertnet.org:8080/ipt/resource?r=dmns_mamm</alternateIdentifier>\n```\n\nYou just created a bridge between our comfortable old creaky shakey location-based world and the cryptographical content-based world!\n\nI need some time to let this sink in. Hoping to put the preston nginx config under version control, so that you can easily install it. How do you think we can best document this?\n\n-jorrit \n","author_association":"MEMBER","reactions":{"url":"https://api.github.com/repos/bio-guoda/preston/issues/comments/721400892/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"performed_via_github_app":null}]